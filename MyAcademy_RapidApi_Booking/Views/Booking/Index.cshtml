@model List<BookingViewModel.Hotel>
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/WebUI/Index.cshtml";
}

    <!-- header-top-->
  
    <div class="header-search vis-search">
        <div class="container">
            <div class="row">
                <!-- header-search-input-item -->
                <div class="col-sm-4">
                    <div class="header-search-input-item fl-wrap location autocomplete-container">
                        <label>Destination or Hotel Name</label>
                        <span class="header-search-input-item-icon"><i class="fal fa-map-marker-alt"></i></span>
                        <input type="text" placeholder="Location" class="autocomplete-input" id="autocompleteid" value="" />
                        <a href="#"><i class="fal fa-dot-circle"></i></a>
                    </div>
                </div>
                <!-- header-search-input-item end -->
                <!-- header-search-input-item -->
                <div class="col-sm-3">
                    <div class="header-search-input-item fl-wrap date-parent">
                        <label>Date In-Out </label>
                        <span class="header-search-input-item-icon"><i class="fal fa-calendar-check"></i></span>
                        <input type="text" placeholder="When" name="header-search" value="" />
                    </div>
                </div>
                <!-- header-search-input-item end -->
                <!-- header-search-input-item -->
                <div class="col-sm-3">
                    <div class="header-search-input-item fl-wrap">
                        <div class="quantity-item">
                            <label>Rooms</label>
                            <div class="quantity">
                                <input type="number" min="1" max="3" step="1" value="1">
                            </div>
                        </div>
                        <div class="quantity-item">
                            <label>Adults</label>
                            <div class="quantity">
                                <input type="number" min="1" max="3" step="1" value="1">
                            </div>
                        </div>
                        <div class="quantity-item">
                            <label>Children</label>
                            <div class="quantity">
                                <input type="number" min="0" max="3" step="1" value="0">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- header-search-input-item end -->
                <!-- header-search-input-item -->
                <div class="col-sm-2">
                    <div class="header-search-input-item fl-wrap">
                        <button class="header-search-button" onclick="window.location.href='listing.html'">Search <i class="far fa-search"></i></button>
                    </div>
                </div>
                <!-- header-search-input-item end -->
            </div>
        </div>
        <div class="close-header-search"><i class="fal fa-angle-double-up"></i></div>
    </div>
    <!-- header-search  end -->



<div id="wrapper">


    <div class="content">
        <!-- Map -->

        <div class="map-container column-map right-pos-map fix-map hid-mob-map">
            <div id="map-main"></div>
            <ul class="mapnavigation">
                <li><a href="#" class="prevmap-nav"><i class="fas fa-caret-left"></i> Prev</a></li>
                <li><a href="#" class="nextmap-nav">Next <i class="fas fa-caret-right"></i></a></li>
            </ul>
            <div class="map-close"><i class="fas fa-times"></i></div>
            <input id="pac-input" name="pacint" class="controls fl-wrap controls-mapwn" type="text" placeholder="What Nearby?">
        </div>

        <!-- Map end -->
        <!--col-list-wrap -->
        <div class="col-list-wrap left-list">
            <div class="mobile-list-controls fl-wrap">
                <div class="container">
                    <div class="mlc show-hidden-column-map schm"><i class="fal fa-map-marked-alt"></i> Show Map</div>
                    <div class="mlc show-list-wrap-search"><i class="fal fa-filter"></i> Filter</div>
                </div>
            </div>
            <!--list-wrap-search   -->
            <form asp-controller="Booking" asp-action="Filter" method="post" id="bookingForm">

                <div class="list-wrap-search fl-wrap lws_mobile" id="lisfw">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="col-list-search-input-item in-loc-dec fl-wrap not-vis-arrow">
                                    <label>Gezi Türü</label>
                                    <div class="listsearch-input-item">
                                        <select name="type" data-placeholder="City" class="chosen-select">
                                            <option>City</option>
                                            <option>Region</option>
                                            <option>district</option>
                                            <option>Landmark</option>
                                            <option>Counrty</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="col-list-search-input-item fl-wrap location autocomplete-container">
                                    <label>Destination</label>
                                    <span class="header-search-input-item-icon"><i class="fal fa-map-marker-alt"></i></span>
                                    <input type="text" placeholder="Destination or Hotel Name" class="autocomplete-input" name="city"  value="" required />
                                    <a href="#"><i class="fal fa-dot-circle"></i></a>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="col-list-search-input-item in-loc-dec date-container fl-wrap">
                                    <label>Date In-Out</label>
                                    <span class="header-search-input-item-icon"><i class="fal fa-calendar-check"></i></span>
                                    <input type="text" placeholder="When" name="dates" value="" required />
                                </div>
                            </div>
                        </div>

                        <div class="search-opt-wrap fl-wrap">
                            <div class="search-opt-wrap-container">

                                <div class="search-input-item midd-input">
                                    <div class="col-list-search-input-item fl-wrap">
                                        <div class="quantity-item">
                                            <label>Rooms</label>
                                            <div class="quantity">
                                                <input type="number" min="1" max="3" step="1" value="1" name="room_qty">
                                            </div>
                                        </div>
                                        <div class="quantity-item">
                                            <label>Adults</label>
                                            <div class="quantity">
                                                <input type="number" min="1" max="5" step="1" value="1" name="adults">
                                            </div>
                                        </div>
                                        <div class="quantity-item">
                                            <label>Children</label>
                                            <div class="quantity">
                                                <input type="number" min="0" max="3" step="1" value="0" name="children">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="search-input-item">
                                    <div class="range-slider-title">Price range</div>
                                    <div class="range-slider-wrap fl-wrap">
                                        <input class="range-slider" id="price-range" data-from="5000" data-to="50000" data-step="50" data-min="50" data-max="100000" data-prefix="TL">

                                        <input type="hidden" name="min_price" id="min_price" value="5000" />
                                        <input type="hidden" name="max_price" id="max_price" value="100000" />
                                    </div>
                                </div>

                                <div class="search-input-item small-input ">
                                    <div class="col-list-search-input-item fl-wrap">
                                        <button class="header-search-button" type="button" id="btnSearch">Search <i class="far fa-search"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="show-more-filters act-hiddenpanel color3-bg"><i class="fal fa-plus"></i><span>More options</span></div>
                        </div>
                    </div>
                </div>
            </form>

            <script>
                document.getElementById('btnSearch').addEventListener('click', function() {

                    // Slider elementini bul
                    var rangeInput = document.getElementById('price-range');

                    // Genellikle slider kütüphaneleri (Ion.RangeSlider gibi) değeri "min;max" stringi olarak tutar
                    // Eğer value boş geliyorsa data-from ve data-to kullanılabilir ama genelde .value özelliği güncellenir.
                    var sliderValue = rangeInput.value;

                    // Eğer slider değeri "500;1500" gibi geliyorsa ayıralım
                    if (sliderValue && sliderValue.includes(';')) {
                        var parts = sliderValue.split(';');
                        document.getElementById('min_price').value = parts[0];
                        document.getElementById('max_price').value = parts[1];
                    } else {
                        // Eğer slider value güncellenmiyorsa (bazı temalarda)
                        // Temanın kendi dokümantasyonuna bakmak gerekir ama manuel olarak data attribute'lardan almayı deneyebiliriz.
                        // (Bu kısım temaya göre değişebilir, standart hali üsttekidir)
                    }

                    // Formu gönder
                    document.getElementById('bookingForm').submit();
                });
            </script>
            <!--list-wrap-search end -->
            <!-- list-main-wrap-->
            <div class="list-main-wrap fl-wrap card-listing">
                <a class="custom-scroll-link back-to-filters" href="#lisfw"><i class="fas fa-angle-up"></i><span>Back to Filters</span></a>
                <div class="container">
                    <!-- list-main-wrap-title-->
                    <div class="list-main-wrap-title fl-wrap">
                        <h2>Results For : <span>@ViewBag.City </span></h2>
                    </div>
                    <!-- list-main-wrap-title end-->
                    <!-- list-main-wrap-opt-->
                    <div class="list-main-wrap-opt fl-wrap">
                        <!-- price-opt-->
                        <div class="price-opt">
                            <span class="price-opt-title">Sort results by:</span>
                            <div class="listsearch-input-item">
                                <select data-placeholder="Popularity" class="chosen-select no-search-select">
                                    <option>Popularity</option>
                                    <option>Average rating</option>
                                    <option>Price: low to high</option>
                                    <option>Price: high to low</option>
                                </select>
                            </div>
                        </div>
                        <!-- price-opt end-->
                        <!-- price-opt-->
                        <div class="grid-opt">
                            <ul>
                                <li><span class="two-col-grid act-grid-opt"><i class="fas fa-th-large"></i></span></li>
                                <li><span class="one-col-grid"><i class="fas fa-bars"></i></span></li>
                            </ul>
                        </div>
                        <!-- price-opt end-->
                    </div>
                    <!-- list-main-wrap-opt end-->
                    <!-- listing-item-container -->
                    <div class="listing-item-container init-grid-items fl-wrap">

                      
                        <!-- listing-item  -->
                        @foreach (var item in Model)
                        {
                            <div class="listing-item">
                                <article class="geodir-category-listing fl-wrap">
                                    <div class="geodir-category-img">
                                        <a href="/Booking/hotelDetails?id=@item.hotel_id&arrivalDate=@ViewBag.arrivalDate&departureDate=@ViewBag.departureDate&adults=@ViewBag.adults">
                                            <img src="@item.property.photoUrls[0]" alt="">
                                        </a>
                                        <div class="geodir-category-opt">
                                            <div class="listing-rating card-popup-rainingvis" data-starrating2="5"></div>
                                            <div class="rate-class-name">
                                                <div class="score"><strong>@item.property.reviewScoreWord</strong>@item.property.reviewCount </div>
                                                <span>@item.property.reviewScore</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="geodir-category-content fl-wrap">
                                        <div class="geodir-category-content-title fl-wrap">
                                            <div class="geodir-category-content-title-item">
                                                <h3 class="title-sin_map"><a href="listing-single.html">@item.property.name</a></h3>
                                                <div class="geodir-category-location fl-wrap"><a href="#0" class="map-item"><i class="fas fa-map-marker-alt"></i>Otel Konumu /@ViewBag.Type</a></div>
                                            </div>
                                        </div>
                                        <p>@(item.accessibilityLabel.Length > 100 ? @item.accessibilityLabel.Substring(0, 100) + "..." : item.accessibilityLabel + ".")</p>
                                        <ul class="facilities-list fl-wrap">
                                            <li><i class="fal fa-wifi"></i><span>Free WiFi</span></li>
                                            <li><i class="fal fa-parking"></i><span>Parking</span></li>
                                            <li><i class="fal fa-smoking-ban"></i><span>Non-smoking Rooms</span></li>
                                            <li><i class="fal fa-utensils"></i><span> Restaurant</span></li>
                                        </ul>
                                        <div class="geodir-category-footer fl-wrap">
                                            <div class="geodir-category-price">Awg/Night <span>@item.property.priceBreakdown.grossPrice.value @item.property.priceBreakdown.grossPrice.currency</span></div>
                                            <div class="geodir-opt-list">
                                                <a href="#0" class="map-item"><i class="fal fa-map-marker-alt"></i><span class="geodir-opt-tooltip">On the map <strong>1</strong></span></a>
                                                <a href="#" class="geodir-js-favorite"><i class="fal fa-heart"></i><span class="geodir-opt-tooltip">Save</span></a>
                                                <a href="#" class="geodir-js-booking"><i class="fal fa-exchange"></i><span class="geodir-opt-tooltip">Find Directions</span></a>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                            </div>


                        }
                        <!-- listing-item end -->
                        <!-- listing-item  -->
                        <!-- listing-item end -->
                    </div>
                    <!-- listing-item-container end-->
                    <!-- pagination-->
                    <div class="pagination">
                        <a href="#" class="prevposts-link"><i class="fa fa-caret-left"></i></a>
                        <a href="#">1</a>
                        <a href="#" class="current-page">2</a>
                        <a href="#">3</a>
                        <a href="#">4</a>
                        <a href="#" class="nextposts-link"><i class="fa fa-caret-right"></i></a>
                    </div>
                    <!-- pagination end-->
                </div>
            </div>
            <!-- list-main-wrap end-->
        </div>
        <!--col-list-wrap end -->
        <div class="limit-box fl-wrap"></div>
    </div>


</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAH8FsQi1oz6kmMUb3fBtDHI1lvuSYNeg"></script>
<script src="https://unpkg.com/@@googlemaps/markerclusterer/dist/index.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    /* HARİTA KUTUSU */
    #map-main {
        width: 100%;
        height: 700px;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        overflow: hidden;
    }

    /* --- POPUP TEMİZLİĞİ --- */
    .gm-style-iw {
        padding: 0 !important;
        overflow: visible !important;
        background: transparent !important;
        box-shadow: none !important;
    }

    .gm-style-iw-d {
        overflow: hidden !important;
        max-height: none !important;
        background: transparent !important;
    }

    .gm-style-iw-tc {
        display: none !important;
    }

    .gm-ui-hover-effect {
        background: white !important;
        border-radius: 50%;
        top: -10px !important;
        right: -10px !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        opacity: 0.9 !important;
    }

    /* --- KART TASARIMI --- */
    .map-wow-card {
        width: 260px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 15px 30px rgba(0,0,0,0.25);
        font-family: 'Segoe UI', sans-serif;
        overflow: hidden;
        animation: fadeIn 0.3s ease-in-out;
        position: relative;
    }

    .wow-image {
        height: 150px;
        background-size: cover;
        background-position: center;
        position: relative;
    }

        .wow-image::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        }

    .wow-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        color: #3B71FE;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 800;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        z-index: 2;
    }

    .wow-details {
        padding: 15px;
    }

        .wow-details h3 {
            margin: 0 0 5px;
            font-size: 16px;
            font-weight: 700;
            color: #222;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    .wow-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #f0f0f0;
    }

    .wow-price {
        color: #E03E26;
        font-weight: 800;
        font-size: 15px;
    }

    .wow-btn {
        background: #222;
        color: white;
        text-decoration: none;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

        .wow-btn:hover {
            background: #3B71FE;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 113, 254, 0.3);
        }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }
</style>

<script>
    function initMap() {
        var locations = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Select(x => new
        {
                lat = x.property.latitude,
                lng = x.property.longitude,
                title = x.property.name,
                image = x.property.photoUrls != null && x.property.photoUrls.Count > 0 ? x.property.photoUrls[0] : "https://via.placeholder.com/300x200?text=No+Image",
                price = x.property.priceBreakdown.grossPrice.value.ToString("N0") + " " + x.property.priceBreakdown.grossPrice.currency,
                review = x.property.reviewScore,
                id = x.hotel_id
        })));

        var mapContainer = document.getElementById('map-main');
        if (!mapContainer) return;

        var centerPos = locations.length > 0 ? { lat: locations[0].lat, lng: locations[0].lng } : { lat: 41.0082, lng: 28.9784 };

        // RENKLİ HARİTA (Style özelliğini sildim, orijinal renkler geldi)
        var map = new google.maps.Map(mapContainer, {
            zoom: 13,
            center: centerPos,
            disableDefaultUI: true,
            zoomControl: true,
            zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_CENTER }
        });

        var infoWindow = new google.maps.InfoWindow();
        var markers = [];

        // --- PIN TASARIMLARI ---

        // Normal (Mavi)
        var iconNormal = {
            path: "M17.5,0c-9.6,0-17.5,7.9-17.5,17.5c0,4.8,1.9,9.4,5.3,12.7l12.2,12.2l12.2-12.2c3.4-3.4,5.3-7.9,5.3-12.7 C35,7.9,27.1,0,17.5,0z",
            fillColor: "#3B71FE",
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: "#FFFFFF",
            scale: 1,
            anchor: new google.maps.Point(17.5, 45),
            labelOrigin: new google.maps.Point(17.5, 18)
        };

        // Hover (Kırmızı ve Büyük)
        var iconHover = {
            path: "M17.5,0c-9.6,0-17.5,7.9-17.5,17.5c0,4.8,1.9,9.4,5.3,12.7l12.2,12.2l12.2-12.2c3.4-3.4,5.3-7.9,5.3-12.7 C35,7.9,27.1,0,17.5,0z",
            fillColor: "#E03E26",
            fillOpacity: 1,
            strokeWeight: 3,
            strokeColor: "#FFFFFF",
            scale: 1.3,
            anchor: new google.maps.Point(17.5, 45),
            labelOrigin: new google.maps.Point(17.5, 18)
        };

        locations.forEach(function(hotel) {
            var marker = new google.maps.Marker({
                position: { lat: hotel.lat, lng: hotel.lng },
                map: map,
                icon: iconNormal,
                animation: google.maps.Animation.DROP,
                label: {
                    text: "\uf236",
                    fontFamily: "'Font Awesome 6 Free'",
                    fontWeight: "900",
                    color: "white",
                    fontSize: "14px"
                }
            });

            // Google Maps Linki
            var googleMapsUrl = `http://maps.google.com/?q=${hotel.lat},${hotel.lng}`;

            var contentString = `
                <div class="map-wow-card">
                    <div class="wow-image" style="background-image: url('${hotel.image}');">
                        <div class="wow-badge"><i class="fas fa-star"></i> ${hotel.review}</div>
                    </div>
                    <div class="wow-details">
                        <h3>${hotel.title}</h3>
                        <div class="wow-footer">
                            <div class="wow-price">${hotel.price}</div>
                            <a href="${googleMapsUrl}" target="_blank" class="wow-btn">
                                <i class="fas fa-location-arrow"></i> Git
                            </a>
                        </div>
                    </div>
                </div>
            `;

            // Olaylar (Hover & Click)
            marker.addListener("mouseover", function() {
                marker.setIcon(iconHover);
                marker.setZIndex(9999);
            });

            marker.addListener("mouseout", function() {
                marker.setIcon(iconNormal);
                marker.setZIndex(1);
            });

            marker.addListener("click", function() {
                infoWindow.setContent(contentString);
                infoWindow.open(map, marker);
            });

            markers.push(marker);
        });

        if (typeof markerClusterer !== 'undefined' && markers.length > 0) {
            new markerClusterer.MarkerClusterer({ markers: markers, map: map });
        }
    }

    window.addEventListener('load', initMap);
</script>