@* AI TERMINAL COMPONENT V2.2 (FIXED LAYOUT & LOGIC) *@

<aside class="w-full h-full min-h-[600px] bg-black flex flex-col border-r border-gray-800 font-mono relative overflow-hidden shadow-2xl">

    <div class="absolute inset-0 pointer-events-none z-10 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10"></div>
    <div class="absolute inset-0 pointer-events-none z-10" style="background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%;"></div>

    <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-black/90 backdrop-blur-sm z-20 shrink-0">
        <div>
            <h2 class="text-xs font-bold uppercase tracking-[0.2em] flex items-center gap-2 text-white">
                <span class="material-symbols-outlined text-green-500 text-lg animate-pulse" style="text-shadow: 0 0 10px #22c55e;">smart_toy</span>
                GEMİNİ_AI_TERMINAL_V2.5
            </h2>
        </div>
        <div class="flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-green-500 animate-ping"></span>
            <div class="text-[9px] text-gray-500 font-semibold">ONLINE @@FIN-BERT</div>
        </div>
    </div>

    <div id="terminal-logs" class="flex-1 overflow-y-auto p-6 space-y-6 text-xs leading-relaxed scrollbar-hide z-20 relative">
        <div class="space-y-1 fade-in">
            <div class="flex justify-between text-[10px] text-gray-600 mb-1 font-semibold">
                <span>[SYSTEM_BOOT]</span>
                <span>@DateTime.Now.ToString("HH:mm:ss")</span>
            </div>
            <div class="p-3 border-l-2 border-green-500 bg-green-900/10">
                <p class="text-green-500/90 font-mono typing-effect">System initialized. Neural connection established...</p>
            </div>
        </div>
    </div>

    <div class="p-5 border-t border-gray-800 bg-black z-20 shrink-0 mt-auto">
        <div class="relative flex items-center group bg-gray-900/30 p-2 border border-gray-800 focus-within:border-green-500/50 transition-colors">
            <span class="text-green-500 mr-3 font-bold text-lg cursor-default select-none">$</span>
            <input id="command-input"
                   autofocus
                   autocomplete="off"
                   class="w-full bg-transparent border-none p-0 text-sm text-white placeholder-gray-700 focus:ring-0 font-mono outline-none"
                   placeholder="ENTER COMMAND..."
                   type="text" />
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
            <button onclick="sendQuickCommand('Analiz Et')" class="text-[10px] px-3 py-1.5 border border-gray-800 text-gray-500 hover:border-green-500 hover:text-green-400 hover:shadow-[0_0_10px_rgba(34,197,94,0.3)] transition-all uppercase tracking-wider">--exec analyze</button>
            <button onclick="clearTerminal()" class="text-[10px] px-3 py-1.5 border border-gray-800 text-gray-500 hover:border-red-500 hover:text-red-400 hover:shadow-[0_0_10px_rgba(239,68,68,0.3)] transition-all uppercase tracking-wider">--purge_logs</button>
        </div>
    </div>
</aside>

<script>

    const inputField = document.getElementById('command-input');
    const terminalLogs = document.getElementById('terminal-logs');

    inputField.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const command = inputField.value;
            if(!command) return;

            // 1. Kullanıcı mesajı
            addLog('OPERATOR', command, 'user');
            inputField.value = '';

            // 2. Yükleniyor Animasyonu Başlat
            const loadingId = showLoading();

            // 3. İstek
            fetch('/Ai/GetResponse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userInput: command })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    typeWriterLog('AI_CORE', data.message);
                } else {
                    addLog('ERROR', data.message, 'error');
                }
            })
            .catch(err => {
                 addLog('FATAL_ERROR', 'Connection Failed: ' + err, 'error');
            })
            .finally(() => {
                // DEĞİŞİKLİK 2: Finally bloğu.
                // İşlem başarılı da olsa, hata da alsa loading çubuğu KESİN silinir.
                const loader = document.getElementById(loadingId);
                if(loader) loader.remove();
            });
        }
    });

    // Standart Mesaj Ekleme
    function addLog(source, message, type) {
        const time = new Date().toLocaleTimeString();
        const id = 'log-' + Date.now();

        let containerClass = "border-l-2 border-gray-700 bg-gray-900/20";
        let textClass = "text-gray-300 terminal-message-text";

        if(type === 'user') {
            containerClass = "border border-white/20 bg-white text-black font-bold shadow-[0_0_15px_rgba(255,255,255,0.1)]";
            textClass = "text-black";
        }
        else if (type === 'error') {
            textClass = "text-red-500 font-bold";
            containerClass = "border-l-2 border-red-500 bg-red-900/10";
        }

        const html = `
            <div id="${id}" class="space-y-1 fade-in">
                <div class="flex justify-between text-[10px] text-gray-600 mb-1 font-mono tracking-wider">
                    <span>[${source}]</span>
                    <span>${time}</span>
                </div>
                <div class="p-3 ${containerClass}">
                    <p class="${textClass}">${message}</p>
                </div>
            </div>
        `;

        terminalLogs.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
        return id;
    }

    // Yükleniyor Animasyonu (Daha stabil bir animasyon)
    function showLoading() {
        const id = 'loading-' + Date.now();
        const html = `
            <div id="${id}" class="space-y-1 fade-in">
                <div class="flex justify-between text-[10px] text-green-500/50 mb-1">
                    <span>[SYSTEM_PROCESS]</span>
                    <span class="animate-pulse">PROCESSING...</span>
                </div>
                <div class="p-3 border border-green-900/30 bg-black">
                    <div class="text-green-500 font-mono text-xs flex gap-1 items-center">
                        <span class="animate-spin material-symbols-outlined text-[10px]">progress_activity</span>
                        <span class="animate-pulse">DATA_STREAM_INCOMING...</span>
                    </div>
                </div>
            </div>
        `;
        terminalLogs.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
        return id;
    }

    // Typewriter Efekti
    function typeWriterLog(source, message) {
        const time = new Date().toLocaleTimeString();
        const id = 'ai-' + Date.now();

        const html = `
            <div id="${id}" class="space-y-1 fade-in">
                <div class="flex justify-between text-[10px] text-green-600 mb-1 font-mono tracking-wider">
                    <span>[${source}]</span>
                    <span>${time}</span>
                </div>
                <div class="p-4 border-l-2 border-green-500 bg-green-900/5 shadow-[0_0_20px_rgba(34,197,94,0.05)]">
                    <p class="text-green-400 font-mono terminal-message-text leading-relaxed" id="text-${id}"></p>
                </div>
            </div>
        `;

        terminalLogs.insertAdjacentHTML('beforeend', html);
        const textElement = document.getElementById(`text-${id}`);
        scrollToBottom();

        // Formatlama
        let formattedMessage = message
            .replace(/\*\*(.*?)\*\*/g, '<b class="text-white text-shadow-sm">$1</b>')
            .replace(/^\* /gm, '<span class="text-green-300">•</span> ');

        textElement.innerHTML = formattedMessage;
    }

    function scrollToBottom() {
        terminalLogs.scrollTop = terminalLogs.scrollHeight;
    }

    function clearTerminal() {
        terminalLogs.innerHTML = '';
    }

    function sendQuickCommand(cmd) {
        inputField.value = cmd;
        inputField.focus();
    }
</script>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

    .font-mono {
        font-family: 'JetBrains Mono', 'Courier New', monospace;
    }

    .terminal-message-text {
        white-space: pre-wrap;
    }

    .text-shadow-sm {
        text-shadow: 0 0 5px rgba(255,255,255,0.5);
    }

    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .fade-in {
        animation: slideUp 0.3s ease-out forwards;
        opacity: 0;
        transform: translateY(10px);
    }

    @@keyframes slideUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>